---
title: "Building Web-Apps with R and SQL Server"
author: "R isn't well known for enterprise Web Applications.  However, recent advancements in the R ecosystem aim to change that.  In this presentation, I will introduce what you need to know for building a production-ready web-app in R."
date: "`r Sys.Date()`"
bibliography: ["citation.bib"]
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r setup, echo=FALSE,warning=FALSE,message=FALSE}
options(htmltools.dir.version = FALSE)
library(DBI)
library(dbplyr)
library(tidyverse)
library(kableExtra)
library(microbenchmark)
library(ggplot2)
#myDriver <- 'SQL Server'
#myServer <- '.\\snapman'
#myDatabase <- 'Cab_Demo'
#sqlchunk_connection <- dbConnect(odbc::odbc(),
#                          Driver= myDriver,
#                          Server = myServer,
#                          Database = myDatabase,
#                          Trusted_Connection='yes')
#comp <- Sys.info()
#if(comp["nodename"]=="OMC-5CG6151GZF"){
#  cab_fileloc <- "C:/Users/MaSharkey/Cab_Data/yellow_tripdata_2018-12.csv"} else {
#  cab_fileloc <- "D:/Cab_data/yellow_tripdata_2018-01.csv"
#  }
```



# About Me

<div>
<center>
.pull-left[
- Matt Sharkey, MBA, MS-BIA, MCSE

- DBA @ BuilderTrend

- Hometown - Winner, SD

]
.pull-right[
<img src="./Images/matthew_sharkey.JPG" alt="me" width="300" height="267">
]



</center>
<div>


---

class: center, middle

![](./Images/silver.JPG)

---


class: center, middle

![](./Images/gold.JPG)


---

class: center, middle

![](./Images/rockstar.JPG)


---

# From IT to Data science

- DBA 


---

# From IT to Data science

- DBA -> Data Engineer


---

# From IT to Data science

- DBA -> Data Engineer

--

- Data Engineer

---

# From IT to Data science

- DBA -> Data Engineer

--

- Data Engineer -> Web Developer?

---


# Web-Dev Simplified

- Shiny -> R packagage for building web apps

--
```{r,eval=FALSE,echo=TRUE}
<h2>Hello World!</h2>
```

<h2>Hello World!</h2>

--

```{r,eval=TRUE,echo=TRUE}
library(shiny)

h2('Hello World!')

```


---
```{r,eval=FALSE,echo=TRUE}
dateRangeInput("date", strong("Date range")
   ,start = "2007-01-01", end = "2017-07-31"
   ,min = "2007-01-01", max = "2017-07-31")
```

--

```{r,eval=FALSE,echo=TRUE}
<div id="date">
<label class="control-label" for="date"> <strong>Date range</strong>
</label><div class="input-daterange input-group">
<input class="input-sm form-control" type="text"
data-date-week-start="0" data-date-format="yyyy-mm-dd"
data-date-start-view="month" data-min-date="2007-01-01" 
data-max-date="2017-07-31"data-initial-date="2007-01-01" 
data-date-autoclose="true"/><span class="input-group-addon">
to </span> <input  type="text" data-date-language="en" 
data-date-week-start="0" data-date-format="yyyy-mm-dd" 
data-min-date="2007-01-01" data-max-date="2017-07-31"/>
  </div></div>
```

--

![](./Images/DateRange.JPG)

---


#Shiny Benefits

- Write application UI and Server side code in R

--

- Integrate R data analysis packages

--

- Hosting https://www.shinyapps.io/

---
<center>
<iframe src="https://msharkey.shinyapps.io/myapp/" height="625" width="650"></iframe>
</center>
---


.pull-left[

# Pros

- Development Speed

- Supportability

]


.pull-right[



---


.pull-left[

# Pros

- Development Speed

- Supportability

]


.pull-right[

# Concerns

- Would I be sacraficing functionality?

- Would I be sacraficing performance?

- "R is not real programming"

]




---


class: inverse, center, middle

# Architecture

---

![](./Images/ShinyArc2.png)

---

![](./Images/ShinyArc1.png)

---

![](./Images/ShinyArc.png)

---

```{r,eval=FALSE}
library(shiny)
library(DBI)
library(odbc)

con <- dbConnect(drv = odbc(),
                 Driver = 'Sql Server',
                 Server = '.\\snapman',
                 Database = 'Test')


```



---

```{r,eval=FALSE}
library(shiny)
library(DBI)
library(odbc)

con <- dbConnect(drv = odbc(),
                 Driver = 'Sql Server',
                 Server = '.\\snapman',
                 Database = 'Test')

{{my_ui <- fluidPage()}}
 

```

---

```{r,eval=FALSE}
library(shiny)
library(DBI)
library(odbc)

con <- dbConnect(drv = odbc(),
                 Driver = 'Sql Server',
                 Server = '.\\snapman',
                 Database = 'Test')

my_ui <- fluidPage()
 
{{my_server <- function(input, output) {}}}

```

---

```{r,eval=FALSE}
library(shiny)
library(DBI)
library(odbc)

con <- dbConnect(drv = odbc(),
                 Driver = 'Sql Server',
                 Server = '.\\snapman',
                 Database = 'Test')

my_ui <- fluidPage()
 
my_server <- function(input, output) {}

{{shinyApp(ui = my_ui, server = my_server)}}
```

---

https://shiny.rstudio.com/gallery/see-more.html

---
class: inverse, center, middle

# 01 Sample App

![](./Images/BaseApp.JPG)


---

# Demo Recap

- Built a user slider control

--

- Defined space for plot output

--

- Added source query text

--

- Executed query

--

- Ploted results

--

- Bound user input to query string

---



---
```{r,eval=FALSE}
Where DATEADD(ms, -1 * (@ts_now - [timestamp]), GETDATE()) >=
  {{DATEADD(minute,-",input$cpu_slider,",Getdate())}}
```

--
```{r,eval=FALSE}
Where DATEADD(ms, -1 * (@ts_now - [timestamp]), GETDATE()) >=
  {{DATEADD(minute,-?cpu_slider_param,Getdate())}}
```
--
```{r,eval=FALSE}
myquery <- sqlInterpolate(con,myquery,
           .dots =c(cpu_slider_param <- input$cpu_slider)
```                                
--
```{r,eval=FALSE}
mydata <- dbGetQuery(con,myquery)
```

---

# Injection Risk

![](./Images/shinybuilderInjection.gif)


---

# Whitelist

```{r,eval=FALSE}
emailwhitelist <- "^[[:alnum:].-_]+@[[:alnum:].-]+$"

if(!is.na(str_match(usr_email, emailwhitelist))){
  #Run query
} else
{
  # Reject input
}
```

---

class: inverse, center, middle


# 02 - Building and Managing Connections

---



class: inverse, center, middle


# Building and Managing Connections


---


```{r commonCon, eval=TRUE, warning=FALSE}
#myconnection <- DBI::dbConnect(odbc::odbc(),
#                          Driver= 'SQL Server',
#                          Server = '.\\snapman',
#                          Database = 'Cab_Demo',
#                          Trusted_Connection='yes')
```

--

```{r execQuery, eval=TRUE, warning=FALSE}

#dbGetQuery(myconnection,"Select GetDate()")
#dbDisconnect(myconnection)

```

---

# Additional Resources

Pluralsight
https://app.pluralsight.com/library/courses/r-programming-fundamentals/table-of-contents

Shiny Gallery
https://shiny.rstudio.com/gallery/

My E-book
https://bookdown.org/msharkey3434/ShinyDB_Book/

My Blog
https://www.hinttank.com/

Advanced R book
https://amzn.to/32qbna4

People to follow
@jcheng,@xieyihui,@hadleywickham,@drob



---







## Common Connection Problems

.pull-left[
1. Wrong connection string format 
    
1. Misspelled something

1. Permissions

1. Driver

1. Wrong port number

1. Firewall
]

.pull-right[
<center>
<iframe src="https://giphy.com/embed/Ym0zs6Ms4vgwU" width="380" height="227" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/mr-robot-rami-malek-its-so-good-Ym0zs6Ms4vgwU"></a></p>
</center>
]


---

## Manual vs Pool

```{r pool, eval=TRUE,echo=FALSE}
#library(pool)
#queries <- c("SELECT Getdate()","Select Getdate()","Select Getdate()","Select Getdate()")
#
#dbconnectworkload <- function() {
# for(i in 1:length(queries)){
#   con <- dbConnect(odbc::odbc(),Driver= myDriver,Server = myServer
#                   ,Database = myDatabase,Trusted_Connection='yes')
#  dbGetQuery(con,queries[i])
#  dbDisconnect(con)
# }
#}  
#
#poolcon <- dbPool(odbc::odbc(),Driver= myDriver,Server = myServer
#                  ,Database = myDatabase,Trusted_Connection='yes')
#
#dbpoolworkload <- function() {
# for(i in 1:length(queries)){dbGetQuery(poolcon,queries[i])}
#}


```

---

## Manual vs Pool Benchmark Results

```{r boxplot,echo=FALSE, fig.align = "center",eval=FALSE}
#rs<-as.data.frame(rs)
#rs$time <- rs$time/1000000
#names(rs) <- c("Connection_Type","Milliseconds")
#ggplot(rs, aes(x=Connection_Type, y=Milliseconds , fill=Connection_Type)) +
# geom_boxplot(alpha=0.4) +
#    theme(text = element_text(size=16))
#
```


---

class: inverse, center, middle

# Performance & Optimization

---


class: center, middle

# Thank You

<iframe src="https://giphy.com/embed/n4oKYFlAcv2AU" width="480" height="270" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/n4oKYFlAcv2AU">via GIPHY</a></p>




