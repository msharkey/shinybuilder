<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 2 Building and Managing Connections | Building Web Applications with Shiny and SQL Server</title>
  <meta name="description" content="A guide to building scalable Shiny Datbase applications">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 2 Building and Managing Connections | Building Web Applications with Shiny and SQL Server" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A guide to building scalable Shiny Datbase applications" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Building and Managing Connections | Building Web Applications with Shiny and SQL Server" />
  
  <meta name="twitter:description" content="A guide to building scalable Shiny Datbase applications" />
  

<meta name="author" content="Matthew Sharkey">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="intro.html">
<link rel="next" href="methods.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="why-read-this-book.html"><a href="why-read-this-book.html"><i class="fa fa-check"></i>Why read this book</a></li>
<li class="chapter" data-level="" data-path="structure-of-the-book.html"><a href="structure-of-the-book.html"><i class="fa fa-check"></i>Structure of the book</a></li>
<li class="chapter" data-level="" data-path="software-information-and-conventions.html"><a href="software-information-and-conventions.html"><i class="fa fa-check"></i>Software information and conventions</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Use Cases for a Relational Database</a></li>
<li class="chapter" data-level="2" data-path="building-and-managing-connections.html"><a href="building-and-managing-connections.html"><i class="fa fa-check"></i><b>2</b> Building and Managing Connections</a><ul>
<li class="chapter" data-level="2.0.1" data-path="building-and-managing-connections.html"><a href="building-and-managing-connections.html#making-a-connection"><i class="fa fa-check"></i><b>2.0.1</b> Making a connection</a></li>
<li class="chapter" data-level="2.0.2" data-path="building-and-managing-connections.html"><a href="building-and-managing-connections.html#common-connection-problems"><i class="fa fa-check"></i><b>2.0.2</b> Common Connection Problems</a></li>
<li class="chapter" data-level="2.0.3" data-path="building-and-managing-connections.html"><a href="building-and-managing-connections.html#executing-a-query"><i class="fa fa-check"></i><b>2.0.3</b> Executing a Query</a></li>
<li class="chapter" data-level="2.0.4" data-path="building-and-managing-connections.html"><a href="building-and-managing-connections.html#one-more-connection-package-to-consider"><i class="fa fa-check"></i><b>2.0.4</b> One more connection package to consider</a></li>
<li class="chapter" data-level="2.0.5" data-path="building-and-managing-connections.html"><a href="building-and-managing-connections.html#dbdisconnectblogpost"><i class="fa fa-check"></i><b>2.0.5</b> dbDisconnect(BlogPost)</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="methods.html"><a href="methods.html"><i class="fa fa-check"></i><b>3</b> Methods</a><ul>
<li class="chapter" data-level="3.0.1" data-path="methods.html"><a href="methods.html#injection-attacks-childs-play"><i class="fa fa-check"></i><b>3.0.1</b> Injection Attacks = Child’s Play</a></li>
<li class="chapter" data-level="3.0.2" data-path="methods.html"><a href="methods.html#breaking-down-a-shiny-app"><i class="fa fa-check"></i><b>3.0.2</b> Breaking Down a Shiny App</a></li>
<li class="chapter" data-level="3.0.3" data-path="methods.html"><a href="methods.html#defending-against-injection"><i class="fa fa-check"></i><b>3.0.3</b> Defending Against Injection</a></li>
<li class="chapter" data-level="3.0.4" data-path="methods.html"><a href="methods.html#defense-in-depth"><i class="fa fa-check"></i><b>3.0.4</b> Defense in Depth</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="applications.html"><a href="applications.html"><i class="fa fa-check"></i><b>4</b> Applications</a><ul>
<li class="chapter" data-level="4.1" data-path="example-one.html"><a href="example-one.html"><i class="fa fa-check"></i><b>4.1</b> Example one</a></li>
<li class="chapter" data-level="4.2" data-path="example-two.html"><a href="example-two.html"><i class="fa fa-check"></i><b>4.2</b> Example two</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>5</b> Final Words</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Building Web Applications with Shiny and SQL Server</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="building-and-managing-connections" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Building and Managing Connections</h1>
<div id="making-a-connection" class="section level3">
<h3><span class="header-section-number">2.0.1</span> Making a connection</h3>
<hr />
<p>R users can integrate SQL Server databases using the DBI and ODBC packages. The first step is to build a connection string. A connection string contains a set of key-value pairs. It tells R where the server is and what user credential to use. Different driver types need different connection string formats. Here are two common connection string configurations.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(DBI)

myDriver &lt;-<span class="st"> &#39;SQL Server&#39;</span>
<span class="co"># Use . for a local connection, otherwise specify Server Machine Name or IP address</span>
myServer &lt;-<span class="st"> &#39;.&#39;</span>
myDatabase &lt;-<span class="st"> &#39;Cab_Demo&#39;</span>


trusted_connection &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),<span class="dt">Driver=</span> myDriver,<span class="dt">Server =</span> myServer
                                ,<span class="dt">Database =</span> myDatabase,<span class="dt">Trusted_Connection=</span><span class="st">&#39;yes&#39;</span>)

myUserid &lt;-<span class="st"> &#39;Cab_App&#39;</span>
myPassword &lt;-<span class="st"> </span><span class="kw">Sys.getenv</span>(<span class="st">&#39;Cab_App_Password&#39;</span>)

connection &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),<span class="dt">Driver=</span> myDriver,<span class="dt">Server =</span> myServer
                        ,<span class="dt">Database =</span> myDatabase,<span class="dt">Uid =</span> myUserid,<span class="dt">Pwd =</span> myPassword)</code></pre>
<p>The trusted_connection uses my windows account instead of a username and password. I prefer windows logins over creating a SQL login because they are easier to manage. My AD system administrator takes care of securing windows credentials. If I use a SQL login, then I’m responsible for guarding and storing the credentials. The second connection string shows how to connect with a SQL login. I use SQL logins for non-windows clients or when connecting to a DB outside the domain. It’s good practice to avoid storing clear text passwords in the client code. So, I stored an environmental variable and accessed it with the Sys.getenv function.</p>
</div>
<div id="common-connection-problems" class="section level3">
<h3><span class="header-section-number">2.0.2</span> Common Connection Problems</h3>
<hr />
<p>I’ve encountered a wide variety of errors when attempting the initial connection. They usually stem from one or more of the following:</p>
<ul>
<li>I didn’t build a valid connection string.
<ul>
<li>ConnectionStrings.com provides a reference for connection string formats.</li>
</ul></li>
<li>I misspelled something.
I need to correct server and database names more than I’d like to admit.</li>
<li>I don’t have permissions to the SQL Server.
<ul>
<li>When I see errors like the “The server principal is not able to access.” then I suspect permissions are the issue. If I don’t own the server, then I submit a ticket to the help desk for authorization. If I own the server, then I check the SQL server logs through SQL Server Management Studio. The logs usually direct me to either create a user or grant permissions.</li>
</ul></li>
<li>I don’t have the right driver selected.
<ul>
<li>It’s easy to attempt a connection with a driver that doesn’t exist on the client. Windows users can check available drivers by searching Administrative tools -&gt; Double click Data Sources. If I publish to an external source, e.g. ShinyApps.IO, then I check their support docs for available driver names. At the time of this blog post, they have SQL Server driver named “SQLServer” available.</li>
</ul></li>
<li>I need to specify the port number.
<ul>
<li>Sometimes the default port is changed from 1433. In that case, I must specify the port number after the server name, e.g. myServer = ‘.,2050’</li>
</ul></li>
<li>A firewall is blocking the connection.
<ul>
<li>One of my <a href="https://www.hinttank.com/troubleshooting-client-connection-issues/">previous blog posts</a> shows how to configure a firewall SQL Server access.</li>
</ul></li>
</ul>
</div>
<div id="executing-a-query" class="section level3">
<h3><span class="header-section-number">2.0.3</span> Executing a Query</h3>
<hr />
<p>Now that I’ve made a connection I’ll verify it with a simple GetDate() query.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbGetQuery</span>(trusted_connection,<span class="st">&quot;Select GetDate()&quot;</span>)
<span class="kw">dbDisconnect</span>(trusted_connection)</code></pre>
<p>I closed the connection by passing the connection variable to the dbDisconnect function. Generally, it is a good idea to close connections after use. Leaving connections open wastes memory and blocks resources for other query sessions. Too many open connections can overload the server and prevent new connections.</p>
<p>I’ll show what open connections look like on the back-end. First, I’ll make five connections using a for loop without invoking dbDisconnect.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)
{
trusted_connection &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),<span class="dt">Driver=</span> myDriver,<span class="dt">Server =</span> myServer
                                ,<span class="dt">Database =</span> myDatabase,<span class="dt">Trusted_Connection=</span><span class="st">&#39;yes&#39;</span>)
date &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(trusted_connection,<span class="kw">paste</span>(<span class="st">&quot;Select GetDate() as mydate,</span><span class="ch">\&#39;</span><span class="st">leakedquery</span><span class="ch">\&#39;</span><span class="st"> as c1,&quot;</span>,i))
}</code></pre>
<p>Here’s a query that a system admin might use to watch database connections. It returns information about the five open connections. I’ve used this query to look for applications that might be leaking connections. If I a lot of sleeping connections then I contacted the app developer for a patch.</p>
<pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> 
    DB_NAME(p.dbid) <span class="kw">as</span> DBName, 
    program_name <span class="kw">as</span> Program,CPU,memusage,status,SPID,nt_username
<span class="kw">FROM</span> sys.sysprocesses p
<span class="kw">Cross</span> apply sys.dm_exec_sql_text(p.sql_handle) d
<span class="kw">WHERE</span>  program_name <span class="op">=</span> <span class="st">&#39;Rstudio&#39;</span>
<span class="kw">and</span> text <span class="kw">like</span> <span class="st">&#39;%leakedquery%&#39;</span> <span class="kw">and</span> text <span class="kw">not</span> <span class="kw">like</span> <span class="st">&#39;%DB_NAME%&#39;</span></code></pre>
<p>I didn’t issue a dbDisconnect, so the connections stays open until the client closes or R runs garbage collection.</p>
</div>
<div id="one-more-connection-package-to-consider" class="section level3">
<h3><span class="header-section-number">2.0.4</span> One more connection package to consider</h3>
<hr />
<p>The pool package opens and closes connections automatically. R users establish a connection to a pool. From then on pool gives the query an idle connection or opens a new connection. Besides simplifying client code, pooled connections can also provide a performance boost. To illustrate, I wrote a sample workload consisting of three queries. Next, I wrote a function to execute the queries using dbConnect/dbDisconnect, and a function to execute the queries using a pool.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(pool)

queries &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SELECT Carrier,count(1)</span>
<span class="st">  FROM [Cab_Demo].[dbo].[flights]</span>
<span class="st">  group by Carrier&quot;</span>,<span class="st">&quot;  Select Avg(distance)</span>
<span class="st">  From [Cab_Demo].[dbo].[flights]&quot;</span>,<span class="st">&quot;  Select top 100 [2012],[2013],[2014],[2015]</span>
<span class="st">  From [Cab_Demo].[dbo].[flights]</span>
<span class="st">  PIVOT ( count(flight)</span>
<span class="st">  FOR year in ([2012],[2013],[2014],[2015])</span>
<span class="st">  ) as pvt&quot;</span>)


dbconnectworkload &lt;-<span class="st"> </span><span class="cf">function</span>() {
  con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),<span class="dt">Driver=</span> myDriver,<span class="dt">Server =</span> myServer
                   ,<span class="dt">Database =</span> myDatabase,<span class="dt">Trusted_Connection=</span><span class="st">&#39;yes&#39;</span>)
  <span class="kw">dbGetQuery</span>(con,queries[<span class="dv">1</span>])
  <span class="kw">dbDisconnect</span>(con)
  con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),<span class="dt">Driver=</span> myDriver,<span class="dt">Server =</span> myServer
                   ,<span class="dt">Database =</span>myDatabase,<span class="dt">Trusted_Connection=</span><span class="st">&#39;yes&#39;</span>)
  <span class="kw">dbGetQuery</span>(con,queries[<span class="dv">2</span>])
  <span class="kw">dbDisconnect</span>(con)
  
  con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),<span class="dt">Driver=</span> myDriver,<span class="dt">Server =</span> myServer
                   ,<span class="dt">Database =</span>myDatabase,<span class="dt">Trusted_Connection=</span><span class="st">&#39;yes&#39;</span>)
  <span class="kw">dbGetQuery</span>(con,queries[<span class="dv">3</span>])
  <span class="kw">dbDisconnect</span>(con)
}

poolcon &lt;-<span class="st"> </span><span class="kw">dbPool</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),<span class="dt">Driver=</span> myDriver,<span class="dt">Server =</span> myServer
                  ,<span class="dt">Database =</span> myDatabase,<span class="dt">Trusted_Connection=</span><span class="st">&#39;yes&#39;</span>)

dbpoolworkload &lt;-<span class="st"> </span><span class="cf">function</span>() {
  <span class="kw">dbGetQuery</span>(poolcon,queries[<span class="dv">1</span>])
  <span class="kw">dbGetQuery</span>(poolcon,queries[<span class="dv">2</span>])
  <span class="kw">dbGetQuery</span>(poolcon,queries[<span class="dv">3</span>])
}

results &lt;-<span class="st"> </span>microbenchmark<span class="op">::</span><span class="kw">microbenchmark</span>(<span class="kw">dbconnectworkload</span>()
                                          ,<span class="kw">dbpoolworkload</span>(),<span class="dt">times =</span> <span class="dv">5</span>)

<span class="kw">poolClose</span>(poolcon)

results</code></pre>
<p>The pooled function connection appears to be 10 times faster. Profvis shows that most of the time spent in dbconnectworkload is on opening connections.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(profvis)

<span class="kw">profvis</span>({<span class="kw">dbconnectworkload</span> ()})</code></pre>
</div>
<div id="dbdisconnectblogpost" class="section level3">
<h3><span class="header-section-number">2.0.5</span> dbDisconnect(BlogPost)</h3>
<hr />
<p>Database interaction starts with a connection. I mentioned a few common connection problems and how to troubleshoot them. Once I have a connection, then I begin testing queries. The DBI function dbGetQuery takes two arguments - 1) the connection 2) a query string. Finally, I mentioned that it’s good to get in the habit of closing connections or use the pool package.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="methods.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["ShinyDB_Book.pdf", "ShinyDB_Book.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
