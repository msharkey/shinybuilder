<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Building Your First Shiny Database Application</title>
    <meta charset="utf-8" />
    <meta name="author" content="Matthew Sharkey | msharkey3434@gmail.com" />
    <meta name="date" content="2019-03-27" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <script src="libs/kePrint/kePrint.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Building Your First Shiny Database Application
### Matthew Sharkey | <a href="mailto:msharkey3434@gmail.com">msharkey3434@gmail.com</a>
### 2019-03-27

---







# About Me

Matthew Sharkey | Data Engineer, HDR

--

Presentation write up on blog [www.hintank.com](https://www.hinttank.com/)

--

Demo Application on github (update with github link)

---


# Agenda

1. Reasons for using a Database

2. Building and Managing Connections

3. Secure Design

4. Performance &amp; Optimization


---

# Reasons to use a Database


Potiential performance gains
--

- Indexing

--

- Parallelism

---

## File vs Table Query

&lt;br&gt;
&lt;br&gt;
&gt; If your data fits in memory there is no advantage to putting it in a database: it will only be slower and more frustrating.

Hadley Wickham, RStudio, Edgar Ruiz. 2019. Dbplyr: A dplyr Back End for Databases. https://CRAN.R-project.org/package=dbplyr.

--

- frustrating --&gt; Possibly

--

- slower --&gt; It depends

---

## Demo File Storage vs SQL Table

 Same data but one stored as CSV and one stored as sql table 
 &lt;div&gt;
 Data source:NYC Yellow Taxi Trips https://www1.nyc.gov/site/
 
--



```r
trips_fs &lt;- read_csv('D:/Cab_data/yellow_tripdata_2018-01.csv')
trips_db &lt;- tbl(con, "yellow_tripdata_2018-01")
```
--

```r
fs &lt;- function(){csvquery&lt;- trips_fs %&gt;%
    filter(tpep_dropoff_datetime &gt;= '2018-01-02 07:28:00'
          ,tpep_dropoff_datetime &lt;= '2018-01-02 07:30:00') %&gt;%
    summarise(pcount= n())
  # Need to force eval per 
  rs&lt;- suppressMessages(compute(csvquery))
  }
```
--

```r
db &lt;- function(){sqltable &lt;- trips_db %&gt;%
    filter(tpep_dropoff_datetime &gt;= '01-02-2018 13:28'
           ,tpep_dropoff_datetime &lt;= '01/02/2018 13:30')  %&gt;%
    summarise(pcount= n())
  rs1&lt;-suppressMessages(compute(sqltable))
  }
```


---

## Benchmarking

File storage is faster


```r
microbenchmark(db(),fs(),times = 10)
```

```
## Unit: milliseconds
##  expr      min       lq     mean   median       uq      max neval
##  db() 249.6644 250.5853 263.8809 263.0479 267.5800 298.1190    10
##  fs() 120.8314 122.6831 134.9648 129.8220 131.2251 176.3928    10
```



---

## But...

Add an index and table outperforms file

--


```r
dbExecute(con,
'CREATE NONCLUSTERED INDEX nc_yellow_trip
 ON [yellow_tripdata_2018-01](tpep_dropoff_datetime)'
 )
```

```
## [1] 0
```
--

```r
microbenchmark(db(),fs(),times = 10)
```

```
## Unit: milliseconds
##  expr       min       lq      mean    median        uq      max neval
##  db()  36.90029  37.8429  53.57198  38.61564  48.44595 123.9228    10
##  fs() 118.95606 120.3897 127.10739 124.42805 132.61016 142.2722    10
```





---

## Other Reasons to use a RDBMS

- Stability

--

- Security

--

- Transactions (ACID)

--

- Change Tracking

--

- But it's not the right tool for every job!

---
## So Help Me Codd!

&lt;br&gt;
&lt;br&gt;
&lt;center&gt;
&gt;IT should never forget that technology is a means to an end, and not an end in itself. Technologies must be evaluated individually in terms of their ability to satisfy the needs of their respective users. IT should never be reluctant to use the most appropriate interface to satisfy users' requirements. Attempting to force one technology or tool to satisfy a particular need for which another tool is more effective and efficient is like attempting to drive a screw into a wall with a hammer when a screwdriver is at hand: the screw may eventually enter the wall but at what cost?

E.F. Codd, et al. 1998. Providing Olap to User-Analysts: An It Mandate. https://bit.ly/2Okyz2H.
&lt;center&gt;

---

# Making a connection

&lt;center&gt;
&lt;iframe src="https://giphy.com/embed/Ym0zs6Ms4vgwU" width="380" height="227" frameBorder="0" class="giphy-embed" allowFullScreen&gt;&lt;/iframe&gt;&lt;p&gt;&lt;a href="https://giphy.com/gifs/mr-robot-rami-malek-its-so-good-Ym0zs6Ms4vgwU"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/center&gt;


--


```r
library(DBI)
myDriver &lt;- 'SQL Server'
myServer &lt;- '.\\snapman'
myDatabase &lt;- 'Cab_Demo'
myconnection &lt;- dbConnect(odbc::odbc(),
                          Driver= myDriver,
                          Server = myServer,
                          Database = myDatabase,
                          Trusted_Connection='yes')
```

---


## Common Connection Problems
--

- Wrong connection string format 
    
    + ConnectionStrings.com
--

- Misspelled something

--

- Permissions

--

- Driver

--

- Wrong port number 

--

- Firewall

---

## Test Query


```r
dbGetQuery(myconnection,"Select GetDate()")
```

```
##                      
## 1 2019-03-27 22:29:07
```

```r
dbDisconnect(myconnection)
```

--


```r
for (i in 1:5)
{
myconnection &lt;- dbConnect(odbc::odbc(),Driver= myDriver
                          ,Server = myServer,Database = myDatabase
                          ,Trusted_Connection='yes')
date &lt;- dbGetQuery(myconnection,paste("Select GetDate() as mydate
                                      ,\'leakedquery\' as c1,",i))
}
```

---

## Leaked Connections



&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; DBName &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Program &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; CPU &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; memusage &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; status &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; SPID &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; nt_username &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;

  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

```
##             used   (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells   1054077   56.3    2066321  110.4   2066321  110.4
## Vcells 163771438 1249.5  269523764 2056.4 251608877 1919.7
```


---

## Manual vs Pool




```r
  dbConnect(odbc::odbc(),Driver= myDriver,Server = myServer
                   ,Database = myDatabase,Trusted_Connection='yes')
  dbGetQuery(con,query)
  dbDisconnect(con)
 }
}  
```
--

```r
poolcon &lt;- dbPool(odbc::odbc(),Driver= myDriver,Server = myServer
                  ,Database = myDatabase,Trusted_Connection='yes')
```
--

```r
microbenchmark::microbenchmark(dbconnectworkload()
                              ,dbpoolworkload()
                              ,times = 10)
```

```
## Unit: milliseconds
##                 expr       min        lq      mean    median        uq
##  dbconnectworkload() 27.987314 29.109683 30.655043 29.766669 30.183458
##     dbpoolworkload()  4.210562  4.302216  4.619726  4.629129  4.822906
##        max neval
##  39.461468    10
##   5.145276    10
```

--- 
---

# Secure Design

- OWASP Top 10 - 2017

--

1. Injection
2. Broker Authentication
3. Sensitive Data Exposure
4. XML External Entities (XXE)
5. Broken Access Control
6. Security Misconfiguration
7. Cross-Site Script (XSS)
8. Insecure Deserialization
9. Using Components with Known Vulnerabilities
10. Insufficient Logging and Monitoring

---

## SQL Injection

&lt;img src="C:/Users/mshar/OneDrive/Documents/R_UG_Demo/sqlinjection.gif" width="700px" /&gt;


---


## Injection Demo



&lt;img src="C:/Users/mshar/OneDrive/Documents/R_UG_Demo/shinybuilderInjection.gif" width="700px" /&gt;

---

## Why Injection works

Unsecure


```r
dbGetQuery(myPool
    ,paste0("Insert into dbo.Persons 
            values ('",input$usr_email,"','",input$usr_title,"')"))
```

--

Better


```r
    params &lt;- c(email = usr_email,title = usr_title)

    query &lt;- "Insert into dbo.Persons values (?email,?title)"
    
    queryint &lt;- sqlInterpolate(myPool, query, .dots = params)
    
    dbGetQuery(myPool, queryint)
```

---

## Whitelist


```r
emailwhitelist &lt;- "^[[:alnum:].-_]+@[[:alnum:].-]+$"

if(!is.na(str_match(input$usr_email, emailwhitelist))){
  
  params &lt;- c(email = input$usr_email,title = input$usr_title)
  
  executeSQL("Insert into dbo.Persons values (?email,?title)",params)
  
} else {stop("Not a valid email.")}
```



## SQL Injection Defense Recap

--

- Grant user least possible permissions

--

- Look out for dynamically generated code

--

- Whitelist Input

--

- Let app interact with interface, not implementation

---


# Performance

- Abstraction - We find virtue between excess and deficiency

--


```r
trips_fs &lt;- 
  readr::read_csv('D:/Cab_Data/yellow_tripdata_2018-01.csv'
                            ,n_max = 3)

trips_fs
```

```
## # A tibble: 3 x 17
##   VendorID tpep_pickup_dateti~ tpep_dropoff_datet~ passenger_count
##      &lt;dbl&gt; &lt;dttm&gt;              &lt;dttm&gt;                        &lt;dbl&gt;
## 1        1 2018-01-01 00:21:05 2018-01-01 00:24:23               1
## 2        1 2018-01-01 00:44:55 2018-01-01 01:03:05               1
## 3        1 2018-01-01 00:08:26 2018-01-01 00:14:21               2
## # ... with 13 more variables: trip_distance &lt;dbl&gt;, RatecodeID &lt;dbl&gt;,
## #   store_and_fwd_flag &lt;chr&gt;, PULocationID &lt;dbl&gt;, DOLocationID &lt;dbl&gt;,
## #   payment_type &lt;dbl&gt;, fare_amount &lt;dbl&gt;, extra &lt;dbl&gt;, mta_tax &lt;dbl&gt;,
## #   tip_amount &lt;dbl&gt;, tolls_amount &lt;dbl&gt;, improvement_surcharge &lt;dbl&gt;,
## #   total_amount &lt;dbl&gt;
```

---




```r
dbCreateTable(con,'yellow_trip_summary_model',trips_fs)
```

--



&lt;div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%; "&gt;&lt;table class="table" style="margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;"&gt; Column_Name &lt;/th&gt;
   &lt;th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;"&gt; Default_Type &lt;/th&gt;
   &lt;th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;"&gt; Hand_Crafted &lt;/th&gt;
   &lt;th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;"&gt; Byte_Difference &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; VendorID &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tinyint &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; tpep_pickup_datetime &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; datetime &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; datetime &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; tpep_dropoff_datetime &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; datetime &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; datetime &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; passenger_count &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tinyint &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; trip_distance &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; smallint &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; RatecodeID &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tinyint &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; store_and_fwd_flag &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; varchar &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; char &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; PULocationID &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; smallint &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; DOLocationID &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; smallint &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; payment_type &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tinyint &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; fare_amount &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; decimal &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; extra &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; decimal &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; mta_tax &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; decimal &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; tip_amount &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; decimal &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; tolls_amount &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; decimal &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; improvement_surcharge &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; decimal &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; total_amount &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; float &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; decimal &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;&lt;/div&gt;


## 67 Bytes Per Row?  So What?

--

- One year of data = 100 million rows

--

- 6.7 GB of wasted space, compounded by:

  * Memory
  * Network
  * Backups
  * Indexes
  * Replication
  
  
---

## Indexes - The Keys to Query Performance


Good columns for indexing

--

- Remember FPOC

--

F - Filtering (Columns used in joins and the filter/WHERE clause)

--

P - Partitioning (columns used in partitioning functions)

--

O- Ordering (ARRANGE/ORDER BY)

--

C- Covering (Any remaining column in the SELECT)


---

## Best index for this query?


```r
trips_db %&gt;%
      mutate(Trip_Date = as.Date(tpep_dropoff_datetime))  %&gt;% 
      filter(tpep_dropoff_datetime &gt;= '01/01/2018',
             tpep_dropoff_datetime &lt; '01/04/2018',
             trip_distance &gt;= 0,
             trip_distance &lt;= 5)  %&gt;%
      group_by(Trip_Date) %&gt;%
      summarise(Trip_Count= n())
```


--

- Per FPOC, I'd start with tpep_dropoff_datetime and trip_distance

--

- Test performance before and after index

- Indexing Trade-offs = Writes Slower

---

## Demo

- Yellow Cab Dashboard

---

# Recap

- Use the right tool for the job
--
- Troubleshooting connections
--
- Preventing SQL Injection
--
- Peformance

--

More in-depth look @ hinttank.com

---

class: center, middle

# Thanks!

Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
